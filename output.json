["Express","Home","Getting started"," Installing "," Hello world "," Express generator "," Basic routing "," Static files "," FAQ ","Guide","Routing","Writing middleware","Using middleware","Using template engines","Error handling","Debugging","Express behind proxies","Moving to Express 4","Moving to Express 5","Database integration","API reference","4.x","3.x (deprecated)","2.x (deprecated)","Advanced topics","Template engines","Using process managers","Security updates","Security best practices","Performance best practices","Resources","Glossary","Middleware","Community","Frameworks","Books and blogs","Companies using Express","Moving to Express 4","Overview","Express 4 is a breaking change from Express 3, so. That means an existing Express 3 app will not work if you update the Express version in its dependencies.","This article covers:","Changes in Express 4."," of migrating an Express 3 app to Express 4.","An example","Upgrading to the Express 4 app generator.","Changes in Express 4","There are several significant changes in Express 4:"," The dependencies on Connect and built-in middleware were removed, so you must add middleware yourself. ","Changes to Express core and middleware system.","Changes to the routing system.","Various other changes.","See also:","New features in 4.x.","Migrating from 3.x to 4.x."," Changes to Express core and middleware system ","Express 4 no longer depends on Connect, and removes all built-in middleware from its core, except for the "," function. This means that Express is now an independent routing and middleware web framework, and Express versioning and releases are not affected by middleware updates.","express.static","Without built-in middleware, you must explicitly add all the middleware that is required to run your app. Simply follow these steps:","Install the module: ","npm install --save <module-name>","In your app, require the module: ","require('module-name')","Use the module according to its documentation: ","app.use( ... )","The following table lists Express 3 middleware and their counterparts in Express 4.","Express 3","Express 4","express.bodyParser"," + ","body-parser","multer","express.compress","compression","express.cookieSession","cookie-session","express.cookieParser","cookie-parser","express.logger","morgan","express.session","express-session","express.favicon","serve-favicon","express.responseTime","response-time","express.errorHandler","errorhandler","express.methodOverride","method-override","express.timeout","connect-timeout","express.vhost","vhost","express.csrf","csurf","express.directory","serve-index","express.static","serve-static","Here is the "," of Express 4 middleware.","complete list","In most cases, you can simply replace the old version 3 middleware with its Express 4 counterpart. For details, see the module documentation in GitHub."," accepts parameters","app.use","In version 4 you can use a variable parameter to define the path where middleware functions are loaded, then read the value of the parameter from the route handler. For example:"," app.use('/book/:id', function(req, res, next) { console.log('ID:', req.params.id); next(); }); "," The routing system ","Apps now implicitly load routing middleware, so you no longer have to worry about the order in which middleware is loaded with respect to the "," middleware.","router","The way you define routes is unchanged, but the routing system has two new features to help organize your routes:","A new method, ",", to create chainable route handlers for a route path.","app.route()","A new class, ",", to create modular mountable route handlers.","express.Router"," method","app.route()","The new "," method enables you to create chainable route handlers for a route path. Because the path is specified in a single location, creating modular routes is helpful, as is reducing redundancy and typos. For more information about routes, see ",".","app.route()"," documentation","Router()","Here is an example of chained route handlers that are defined by using the "," function.","app.route()"," app.route('/book') .get(function(req, res) { res.send('Get a random book'); }) .post(function(req, res) { res.send('Add a book'); }) .put(function(req, res) { res.send('Update the book'); }); "," class","express.Router","The other feature that helps to organize routes is a new class, ",", that you can use to create modular mountable route handlers. A "," instance is a complete middleware and routing system; for this reason it is often referred to as a “mini-app”.","express.Router","Router","The following example creates a router as a module, loads middleware in it, defines some routes, and mounts it on a path on the main app.","For example, create a router file named "," in the app directory, with the following content:","birds.js"," var express = require('express'); var router = express.Router(); // middleware specific to this router router.use(function timeLog(req, res, next) { console.log('Time: ', Date.now()); next(); }); // define the home page route router.get('/', function(req, res) { res.send('Birds home page'); }); // define the about route router.get('/about', function(req, res) { res.send('About birds'); }); module.exports = router; ","Then, load the router module in the app:"," var birds = require('./birds'); ... app.use('/birds', birds); ","The app will now be able to handle requests to the "," and "," paths, and will call the "," middleware that is specific to the route.","/birds","/birds/about","timeLog"," Other changes ","The following table lists other small but important changes in Express 4:","Object","Description","Node.js","Express 4 requires Node.js 0.10.x or later and has dropped support for Node.js 0.8.x.","http.createServer()","The "," module is no longer needed, unless you need to directly work with it (socket.io/SPDY/HTTPS). The app can be started by using the "," function.","http","app.listen()","app.configure()","The "," function has been removed. Use the "," or "," function to detect the environment and configure the app accordingly.","app.configure()","process.env.NODE_ENV","app.get('env')","json spaces","The "," application property is disabled by default in Express 4.","json spaces","req.accepted()","Use ",", ",", ",", and ",".","req.accepts()","req.acceptsEncodings()","req.acceptsCharsets()","req.acceptsLanguages()","res.location()","No longer resolves relative URLs.","req.params","Was an array; now an object.","res.locals","Was a function; now an object.","res.headerSent","Changed to ",".","res.headersSent","app.route","Now available as ",".","app.mountpath","res.on('header')","Removed.","res.charset","Removed.","res.setHeader('Set-Cookie', val)","Functionality is now limited to setting the basic cookie value. Use "," for added functionality.","res.cookie()","Example app migration","Here is an example of migrating an Express 3 application to Express 4. The files of interest are "," and ",".","app.js","package.json"," Version 3 app ","app.js","Consider an Express v.3 application with the following "," file:","app.js"," var express = require('express'); var routes = require('./routes'); var user = require('./routes/user'); var http = require('http'); var path = require('path'); var app = express(); // all environments app.set('port', process.env.PORT || 3000); app.set('views', path.join(__dirname, 'views')); app.set('view engine', 'jade'); app.use(express.favicon()); app.use(express.logger('dev')); app.use(express.methodOverride()); app.use(express.session({ secret: 'your secret here' })); app.use(express.bodyParser()); app.use(app.router); app.use(express.static(path.join(__dirname, 'public'))); // development only if ('development' == app.get('env')) { app.use(express.errorHandler()); } app.get('/', routes.index); app.get('/users', user.list); http.createServer(app).listen(app.get('port'), function(){ console.log('Express server listening on port ' + app.get('port')); }); ","package.json","The accompanying version 3 "," file might look something like this:","package.json"," { \"name\": \"application-name\", \"version\": \"0.0.1\", \"private\": true, \"scripts\": { \"start\": \"node app.js\" }, \"dependencies\": { \"express\": \"3.12.0\", \"jade\": \"*\" } } "," Process ","Begin the migration process by installing the required middleware for the Express 4 app and updating Express and Jade to their respective latest version with the following command:"," $ npm install serve-favicon morgan method-override express-session body-parser multer errorhandler express@latest jade@latest --save ","Make the following changes to ",":","app.js","The built-in Express middleware functions ",", ",", ",", ",", "," and "," are no longer available on the "," object. You must install their alternatives manually and load them in the app.","express.favicon","express.logger","express.methodOverride","express.session","express.bodyParser","express.errorHandler","express","You no longer need to load the "," function. It is not a valid Express 4 app object, so remove the "," code.","app.router","app.use(app.router);","Make sure that the middleware functions are loaded in the correct order - load "," after loading the app routes.","errorHandler","Version 4 app","package.json","Running the above "," command will update "," as follows:","npm","package.json"," { \"name\": \"application-name\", \"version\": \"0.0.1\", \"private\": true, \"scripts\": { \"start\": \"node app.js\" }, \"dependencies\": { \"body-parser\": \"^1.5.2\", \"errorhandler\": \"^1.1.1\", \"express\": \"^4.8.0\", \"express-session\": \"^1.7.2\", \"jade\": \"^1.5.0\", \"method-override\": \"^2.1.2\", \"morgan\": \"^1.2.2\", \"multer\": \"^0.1.3\", \"serve-favicon\": \"^2.0.1\" } } ","app.js","Then, remove invalid code, load the required middleware, and make other changes as necessary. The "," file will look like this:","app.js"," var http = require('http'); var express = require('express'); var routes = require('./routes'); var user = require('./routes/user'); var path = require('path'); var favicon = require('serve-favicon'); var logger = require('morgan'); var methodOverride = require('method-override'); var session = require('express-session'); var bodyParser = require('body-parser'); var multer = require('multer'); var errorHandler = require('errorhandler'); var app = express(); // all environments app.set('port', process.env.PORT || 3000); app.set('views', path.join(__dirname, 'views')); app.set('view engine', 'jade'); app.use(favicon(__dirname + '/public/favicon.ico')); app.use(logger('dev')); app.use(methodOverride()); app.use(session({ resave: true, saveUninitialized: true, secret: 'uwotm8' })); app.use(bodyParser.json()); app.use(bodyParser.urlencoded({ extended: true })); app.use(multer()); app.use(express.static(path.join(__dirname, 'public'))); app.get('/', routes.index); app.get('/users', user.list); // error handling middleware should be loaded after the loading the routes if ('development' == app.get('env')) { app.use(errorHandler()); } var server = http.createServer(app); server.listen(app.get('port'), function(){ console.log('Express server listening on port ' + app.get('port')); }); ","Unless you need to work directly with the "," module (socket.io/SPDY/HTTPS), loading it is not required, and the app can be simply started this way:","http","app.listen(app.get('port'), function(){ console.log('Express server listening on port ' + app.get('port')); });","Run the app","The migration process is complete, and the app is now an Express 4 app. To confirm, start the app by using the following command:"," $ node . ","Load "," and see the home page being rendered by Express 4.","http://localhost:3000","Upgrading to the Express 4 app generator","The command-line tool to generate an Express app is still ",", but to upgrade to the new version, you must uninstall the Express 3 app generator and then install the new ",".","express","express-generator","Installing ","If you already have the Express 3 app generator installed on your system, you must uninstall it:"," $ npm uninstall -g express ","Depending on how your file and directory privileges are configured, you might need to run this command with ",".","sudo","Now install the new generator:"," $ npm install -g express-generator ","Depending on how your file and directory privileges are configured, you might need to run this command with ",".","sudo","Now the "," command on your system is updated to the Express 4 generator.","express","Changes to the app generator ","Command options and use largely remain the same, with the following exceptions:","Removed the "," option.","--sessions","Removed the "," option.","--jshtml","Added the "," option to support ",".","--hogan","Hogan.js","Example","Execute the following command to create an Express 4 app:"," $ express app4 ","If you look at the contents of the "," file, you will notice that all the middleware functions (except ",") that are required for the app are loaded as independent modules, and the "," middleware is no longer explicitly loaded in the app.","app4/app.js","express.static","router","You will also notice that the "," file is now a Node.js module, in contrast to the standalone app that was generated by the old generator.","app.js","After installing the dependencies, start the app by using the following command:"," $ npm start ","If you look at the npm start script in the "," file, you will notice that the actual command that starts the app is ",", which used to be "," in Express 3.","package.json","node ./bin/www","node app.js","Because the "," file that was generated by the Express 4 generator is now a Node.js module, it can no longer be started independently as an app (unless you modify the code). The module must be loaded in a Node.js file and started via the Node.js file. The Node.js file is "," in this case.","app.js","./bin/www","Neither the "," directory nor the extensionless "," file is mandatory for creating an Express app or starting the app. They are just suggestions made by the generator, so feel free to modify them to suit your needs.","bin","www","To get rid of the "," directory and keep things the “Express 3 way”, delete the line that says "," at the end of the "," file, then paste the following code in its place:","www","module.exports = app;","app.js"," app.set('port', process.env.PORT || 3000); var server = app.listen(app.get('port'), function() { debug('Express server listening on port ' + server.address().port); }); ","Ensure that you load the "," module at the top of the "," file by using the following code:","debug","app.js"," var debug = require('debug')('app4'); ","Next, change "," in the "," file to ",".","\"start\": \"node ./bin/www\"","package.json","\"start\": \"node app.js\"","You have now moved the functionality of "," back to ",". This change is not recommended, but the exercise helps you to understand how the "," file works, and why the "," file no longer starts on its own.","./bin/www","app.js","./bin/www","app.js"," is a project of the ","Node.js Foundation.","Express",". ","Fork the website on GitHub","Copyright © 2016 StrongLoop, IBM, and other expressjs.com contributors."]
